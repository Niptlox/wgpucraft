# ТЗ.md — “WGPUcraft → Playable Edition (Windows)”

## 1) Цель проекта

Сделать из текущего прототипа WGPUcraft **играбельную** версию “как Minecraft-лайт”:

* нормальная мышь + управление
* стабильный FPS (по умолчанию 60)
* инвентарь + хотбар + взаимодействие с блоками
* адекватная генерация мира (долины/озёра/горы/деревья)
* базовая приятная графика (мягкое освещение + мягкие тени хотя бы приближённо)
* лёгкая физика без просадки FPS
* мультиплеер с различимыми игроками (stickmen + цвет головы + никнейм над игроком при наведении взглядом)
* агент **сам** решает архитектуру, зависимости, подходы, и доводит до рабочего состояния с проверкой

## 2) Ограничения и важные правила

1. **Windows — приоритет №1** (сборка и запуск должны работать на Windows).
2. **Tracy не ломать**: текущая логика “Tracy как отдельная фича/через конфиг” должна сохраниться.

   * Если добавляется ещё профилирование/трейсинг — **только аналогично**: включение через конфиг/feature, по умолчанию выключено.
3. Агент **не задаёт вопросы**, а принимает решения сам.
4. Агент обязан:

   * чинить ошибки сборки,
   * проверять, что проект запускается,
   * добавлять самопроверки (тесты/прогоны/инструкции),
   * при проблемах — сам искать причину и исправлять.

## 3) Definition of Done (приёмка)

Проект считается готовым, если выполнены пункты:

### 3.1 Билд/запуск

* `cargo build` и `cargo run` успешно на Windows (MSVC toolchain).
* Есть документ “BUILD_AND_RUN.md” с инструкциями.
* Есть режим “release”: `cargo run --release` даёт стабильную работу.

### 3.2 Управление и мышь (критично)

* Мышь работает адекватно:

  * захват курсора (toggle: например, `Esc` снимает захват, `Click` возвращает),
  * плавное вращение камеры,
  * настраиваемая чувствительность (config),
  * без рывков/ускорений “как попало”.
* Управление:

  * WASD + прыжок + бег (опционально) + приседание (опционально),
  * скорости настраиваются.

### 3.3 FPS / производительность

* По умолчанию лимит кадров **60 FPS** (и VSync/Frame cap нормально управляются).
* Цель: на средней машине не падать ниже 60 в стартовой зоне.
* Если сейчас “упирается в 30” — агент обязан:

  * найти причину (vsync/лимитер/тайминг/луп),
  * исправить (правильный cap, корректный delta time, winit/wgpu present mode).

### 3.4 Инвентарь и строительство “как в Minecraft”

Минимально обязательное:

* Хотбар на 9 слотов (цифры 1–9, колесо мыши).
* Инвентарь (UI окно):

  * отображение списка блоков/предметов (можно начать с creative-инвентаря),
  * перенос/выбор (drag&drop — по возможности, иначе кликами).
* Разрушение и установка блоков:

  * ЛКМ — ломать (с задержкой/анимацией опционально),
  * ПКМ — ставить,
  * корректный raycast по блокам,
  * нельзя ставить блок внутрь игрока.

### 3.5 Мир и генерация (приятно и разнообразно)

* Должны быть:

  * долины/низины,
  * озёра (вода),
  * горы/холмы,
  * деревья (простая генерация).
* Генерация должна быть детерминированной по seed (seed в config).
* Дистанция прорисовки/симуляции — настраиваемая (config).
* Вода может быть простой (плоская поверхность), но должна выглядеть “норм”.

### 3.6 Графика: мягкое освещение и мягкие тени (лайт-версия)

Требование: “не без шейдеров”, а **приятно**.
Минимальный набор:

* Directional light (условное “солнце”) + ambient.
* “Мягкое освещение” (варианты на выбор агента):

  * простой AO (screen-space AO или voxel AO на вершинах/гранях),
  * либо vertex-AO на кубах,
  * либо упрощённый light propagation без тяжёлой GI.
* “Мягкие тени” (варианты на выбор агента):

  * простые cascaded shadow maps (дорого, но можно ограничить),
  * или одна shadow map малого разрешения + PCF/PCSS-подобное размытие,
  * или контактные тени как пост-эффект (если проще).
    Главное: **визуально** тени/освещение должны быть заметны, но FPS не должен проседать.

### 3.7 Физика (лёгкая, без просадок)

* Игрок:

  * коллизии с блоками,
  * гравитация,
  * прыжок,
  * скольжение/ступеньки (упрощённо допустимо).
* “Ненапряжная” физика:

  * агент может выбрать готовую либу (например, rapier3d) **или** написать простую свою.
  * Важнее стабильный FPS и предсказуемость.
* Опционально: простые “физические” блоки (падающий песок) — не обязательно, но приветствуется.

### 3.8 Мультиплеер (обязателен)

Архитектура на усмотрение агента, но требования такие:

**Функционал**

* Режим сервер/клиент (dedicated server или listen-server).
* Несколько игроков одновременно.
* Игроки видят друг друга в мире и синхронизируются:

  * позиция/поворот,
  * выбранный блок/анимация рук (минимально — ок),
  * установки/разрушения блоков синхронно всем.

**Различимость игроков**

* Модель игрока: “stickman” (палочный человечек) + голова “огурчик/сфера/капсула”.
* При входе:

  * выбор цвета головы (палитра),
  * ввод/выбор никнейма.
* Никнейм:

  * отображается **над игроком**,
  * показывается **только если игрок в прицеле/взгляде** (например, если crosshair направлен на него и он в разумной дистанции),
  * или “fade in/out” допустимо.

**Быстрота**

* Минимальная задержка и экономия трафика:

  * снапшоты/дельты,
  * интерполяция на клиенте,
  * тикрейт/частота обновлений настраиваемая.

**Проверка**

* Агент обязан сам проверить мультиплеер:

  * минимум 2 клиента + сервер локально,
  * описать шаги проверки в “MULTIPLAYER_TEST.md”.

### 3.9 Ассеты и отсутствие текстур

* Если нет готовых текстур/картинок:

  * агент делает процедурные материалы (solid colors / palette),
  * выбирает “красивые” сочетаемые цвета сам (палитра).
* Не блокировать прогресс из-за ассетов: всё должно работать без внешних ресурсов.

---

## 4) Конфигурация и UX

Должен быть единый конфиг (например, `config.toml` или `config.json`) с параметрами:

* mouse_sensitivity
* invert_y (опционально)
* fps_cap (default 60)
* vsync on/off
* render_distance (chunks)
* seed
* multiplayer: ip/port, player_name, head_color
* debug flags (wireframe, show_fps, etc.)
* профилирование/трейсинг (Tracy) — **включение только через config/feature**

---

## 5) Техническая архитектура (как должен думать агент)

Агент сам выбирает решения, но обязан обеспечить:

### 5.1 Модули/слои (минимум)

* `core/` — тайминг, config, логирование
* `render/` — wgpu пайплайны, шейдеры, материалы
* `world/` — чанки, генерация, блоки, сохранение (опционально)
* `player/` — контроллер, коллизии
* `ui/` — хотбар/инвентарь/текст
* `net/` — протокол, клиент/сервер, репликация

### 5.2 Обязательная оптимизация вокселей

* Мешинг чанков должен быть адекватным:

  * greedy meshing (желательно) или хотя бы нормальное объединение граней,
  * culling невидимых граней,
  * пересоздание меша только для изменённых чанков.
* Батчинг/инстансинг по возможности.
* Минимизировать draw calls и перерасчёты.

---

## 6) Самопроверка агента (обязательно)

Агент обязан добавить “гарантии”, что оно реально работает:

1. **Автоматические проверки**

* `cargo fmt` / `cargo clippy` без критичных ошибок.
* Минимум один тест (например, генерация чанка детерминирована по seed).
* Опционально: GitHub Actions workflow (если репо публичное) — Windows build.

2. **Ручные чек-листы**

* `QA_CHECKLIST.md`:

  * мышь (захват, чувствительность),
  * ломание/постановка,
  * инвентарь,
  * генерация биомов/воды/деревьев,
  * FPS 60 cap,
  * мультиплеер шаги.

3. **Встроенная диагностика**

* overlay: FPS, frame time, количество чанков, draw calls (если легко).

---

## 7) План работ (Milestones)

Агент должен выполнять в таком порядке (чтобы всегда было “играбельно”):

**M1 — Стабильный Windows билд + управление**

* фиксы сборки
* тайминг + fps cap + vsync
* исправление мыши и захвата

**M2 — Блоки и взаимодействие**

* raycast
* place/break
* хотбар

**M3 — Инвентарь UI**

* окно инвентаря
* выбор блоков

**M4 — Генерация мира**

* seed
* озёра/горы/долины
* деревья
* параметры в конфиге

**M5 — Оптимизация FPS**

* мешинг/чанки
* устранение лишних пересборок/копий
* цель: стабильные 60

**M6 — Графика**

* освещение + AO
* мягкие тени (упрощённо)
* приятная палитра/материалы

**M7 — Физика**

* коллизии игрока
* лёгкая физика без просадок

**M8 — Мультиплеер**

* server/client
* синк игроков и блоков
* stickmen + цвет + ник
* проверка мультиплеера

---

## 8) Итоговые артефакты (что агент должен оставить в репозитории)

* Рабочий код
* `BUILD_AND_RUN.md`
* `QA_CHECKLIST.md`
* `MULTIPLAYER_TEST.md`
* `CONFIG.md` (описание параметров)
* (желательно) `CHANGELOG.md` с кратким списком улучшений


